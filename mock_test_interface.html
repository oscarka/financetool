<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª MCPæ™ºèƒ½å›¾è¡¨ç³»ç»Ÿ - Mockæµ‹è¯•ç•Œé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            background: #fafafa;
        }
        
        .test-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        input[type="text"], input[type="url"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="url"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        textarea {
            height: 120px;
            resize: vertical;
        }
        
        .btn {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(90deg, #2196F3, #1976D2);
        }
        
        .btn-danger {
            background: linear-gradient(90deg, #f44336, #d32f2f);
        }
        
        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: #4CAF50;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .sample-data {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .sample-data h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª MCPæ™ºèƒ½å›¾è¡¨ç³»ç»Ÿ</h1>
            <p>Mockæµ‹è¯•ç•Œé¢ - æ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–ç»„ä»¶</p>
        </div>
        
        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('mcp-client')">MCPå®¢æˆ·ç«¯æµ‹è¯•</button>
                <button class="tab" onclick="showTab('api-test')">APIç«¯ç‚¹æµ‹è¯•</button>
                <button class="tab" onclick="showTab('llm-test')">LLMé›†æˆæµ‹è¯•</button>
                <button class="tab" onclick="showTab('end-to-end')">ç«¯åˆ°ç«¯æµ‹è¯•</button>
            </div>
            
            <!-- MCPå®¢æˆ·ç«¯æµ‹è¯• -->
            <div id="mcp-client" class="tab-content active">
                <div class="test-section">
                    <h2>ğŸ”— MCPæ•°æ®åº“å®¢æˆ·ç«¯æ¨¡æ‹Ÿ</h2>
                    <p style="margin-bottom: 20px; color: #666;">
                        æ¨¡æ‹ŸMCPæœåŠ¡å™¨è¿æ¥å’ŒSQLæŸ¥è¯¢ï¼Œæ— éœ€å®é™…çš„PostgreSQLè¿æ¥
                    </p>
                    
                    <div class="form-group">
                        <label for="mcp-server-url">MCPæœåŠ¡å™¨URL:</label>
                        <input type="url" id="mcp-server-url" value="http://localhost:3001" placeholder="http://localhost:3001">
                    </div>
                    
                    <div class="form-group">
                        <label for="natural-question">è‡ªç„¶è¯­è¨€é—®é¢˜:</label>
                        <select id="natural-question" onchange="loadQuestionTemplate()">
                            <option value="">é€‰æ‹©ä¸€ä¸ªç¤ºä¾‹é—®é¢˜...</option>
                            <option value="æ˜¾ç¤ºå„å¹³å°çš„èµ„äº§åˆ†å¸ƒ">æ˜¾ç¤ºå„å¹³å°çš„èµ„äº§åˆ†å¸ƒ</option>
                            <option value="å„èµ„äº§ç±»å‹çš„å æ¯”">å„èµ„äº§ç±»å‹çš„å æ¯”</option>
                            <option value="æœ€è¿‘30å¤©çš„èµ„äº§å˜åŒ–è¶‹åŠ¿">æœ€è¿‘30å¤©çš„èµ„äº§å˜åŒ–è¶‹åŠ¿</option>
                            <option value="æŠ•èµ„æ”¶ç›Šæ’è¡Œ">æŠ•èµ„æ”¶ç›Šæ’è¡Œ</option>
                            <option value="è¯¦ç»†çš„äº¤æ˜“è®°å½•">è¯¦ç»†çš„äº¤æ˜“è®°å½•</option>
                            <option value="custom">è‡ªå®šä¹‰é—®é¢˜...</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="custom-question-group" style="display: none;">
                        <label for="custom-question">è‡ªå®šä¹‰é—®é¢˜:</label>
                        <input type="text" id="custom-question" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...">
                    </div>
                    
                    <div class="form-group">
                        <label for="mock-sql">æ¨¡æ‹Ÿç”Ÿæˆçš„SQL (å¯ç¼–è¾‘):</label>
                        <textarea id="mock-sql" placeholder="SELECTå¹³å°, SUM(ä½™é¢) FROM èµ„äº§å¿«ç…§ GROUP BY å¹³å°"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="mock-data">æ¨¡æ‹ŸæŸ¥è¯¢ç»“æœ (JSONæ ¼å¼):</label>
                        <textarea id="mock-data" placeholder="æ¨¡æ‹Ÿçš„æ•°æ®åº“æŸ¥è¯¢ç»“æœ"></textarea>
                    </div>
                    
                    <button class="btn" onclick="testMCPClient()">ğŸ” æµ‹è¯•MCPå®¢æˆ·ç«¯</button>
                    <button class="btn btn-secondary" onclick="loadSampleData()">ğŸ“Š åŠ è½½ç¤ºä¾‹æ•°æ®</button>
                    <button class="btn btn-danger" onclick="clearMCPResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
                    
                    <div id="mcp-status"></div>
                    <div id="mcp-results" class="result-box" style="display: none;"></div>
                </div>
            </div>
            
            <!-- APIç«¯ç‚¹æµ‹è¯• -->
            <div id="api-test" class="tab-content">
                <div class="test-section">
                    <h2>ğŸŒ FastAPIç«¯ç‚¹æ¨¡æ‹Ÿ</h2>
                    <p style="margin-bottom: 20px; color: #666;">
                        æ¨¡æ‹ŸFastAPIå›¾è¡¨ç”Ÿæˆç«¯ç‚¹ï¼Œæµ‹è¯•å®Œæ•´çš„è¯·æ±‚å“åº”æµç¨‹
                    </p>
                    
                    <div class="grid">
                        <div>
                            <div class="form-group">
                                <label for="api-base-url">APIåŸºç¡€URL:</label>
                                <input type="url" id="api-base-url" value="http://localhost:8000" placeholder="http://localhost:8000">
                            </div>
                            
                            <div class="form-group">
                                <label for="api-question">é—®é¢˜:</label>
                                <input type="text" id="api-question" value="æ˜¾ç¤ºå„å¹³å°çš„èµ„äº§åˆ†å¸ƒ" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜">
                            </div>
                            
                            <div class="form-group">
                                <label for="base-currency">åŸºå‡†è´§å¸:</label>
                                <select id="base-currency">
                                    <option value="CNY">CNY (äººæ°‘å¸)</option>
                                    <option value="USD">USD (ç¾å…ƒ)</option>
                                    <option value="EUR">EUR (æ¬§å…ƒ)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="max-rows">æœ€å¤§è¿”å›è¡Œæ•°:</label>
                                <input type="number" id="max-rows" value="1000" min="1" max="10000">
                            </div>
                        </div>
                        
                        <div>
                            <div class="sample-data">
                                <h4>ğŸ“‹ æ”¯æŒçš„æŸ¥è¯¢ç¤ºä¾‹:</h4>
                                <ul style="padding-left: 20px;">
                                    <li>æ˜¾ç¤ºå„å¹³å°çš„èµ„äº§åˆ†å¸ƒ</li>
                                    <li>å„èµ„äº§ç±»å‹çš„å æ¯”</li>
                                    <li>æœ€è¿‘30å¤©çš„èµ„äº§å˜åŒ–è¶‹åŠ¿</li>
                                    <li>æŠ•èµ„æ”¶ç›Šæ’è¡Œ</li>
                                    <li>è¯¦ç»†çš„äº¤æ˜“è®°å½•</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="testAPIEndpoint()">ğŸš€ æµ‹è¯•APIç«¯ç‚¹</button>
                    <button class="btn btn-secondary" onclick="checkAPIHealth()">â¤ï¸ å¥åº·æ£€æŸ¥</button>
                    <button class="btn btn-secondary" onclick="getAPIExamples()">ğŸ“ è·å–ç¤ºä¾‹</button>
                    
                    <div id="api-status"></div>
                    <div id="api-results" class="result-box" style="display: none;"></div>
                </div>
            </div>
            
            <!-- LLMé›†æˆæµ‹è¯• -->
            <div id="llm-test" class="tab-content">
                <div class="test-section">
                    <h2>ğŸ¤– LLM APIé›†æˆæµ‹è¯•</h2>
                    <p style="margin-bottom: 20px; color: #666;">
                        <strong>âš ï¸ è¿™é‡Œå¯ä»¥è¾“å…¥æ‚¨çš„LLM APIå¯†é’¥è¿›è¡Œæµ‹è¯•</strong>
                    </p>
                    
                    <div class="status info">
                        <strong>ğŸ’¡ æç¤º:</strong> 
                        å½“å‰ç³»ç»Ÿä¸»è¦ä½¿ç”¨é¢„è®¾æ¨¡æ¿åŒ¹é…ï¼ŒLLMä¸»è¦ç”¨äºå¤„ç†å¤æ‚çš„è‡ªç„¶è¯­è¨€ç†è§£ã€‚
                        æ‚¨å¯ä»¥åœ¨è¿™é‡Œæµ‹è¯•LLMå¢å¼ºåŠŸèƒ½ã€‚
                    </div>
                    
                    <div class="form-group">
                        <label for="llm-provider">LLMæä¾›å•†:</label>
                        <select id="llm-provider" onchange="updateLLMConfig()">
                            <option value="openai">OpenAI GPT</option>
                            <option value="anthropic">Anthropic Claude</option>
                            <option value="moonshot">Moonshot (æœˆä¹‹æš—é¢)</option>
                            <option value="zhipu">æ™ºè°±æ¸…è¨€ (GLM)</option>
                            <option value="tongyi">é€šä¹‰åƒé—®</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="llm-api-key">APIå¯†é’¥:</label>
                        <input type="password" id="llm-api-key" placeholder="sk-... æˆ–å¯¹åº”çš„APIå¯†é’¥">
                        <small style="color: #666;">å¯†é’¥ä»…ç”¨äºå½“å‰ä¼šè¯æµ‹è¯•ï¼Œä¸ä¼šè¢«ä¿å­˜</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="llm-base-url">APIåŸºç¡€URL (å¯é€‰):</label>
                        <input type="url" id="llm-base-url" placeholder="https://api.openai.com/v1 (ç•™ç©ºä½¿ç”¨é»˜è®¤)">
                    </div>
                    
                    <div class="form-group">
                        <label for="llm-model">æ¨¡å‹:</label>
                        <select id="llm-model">
                            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                            <option value="gpt-4">gpt-4</option>
                            <option value="claude-3-sonnet">claude-3-sonnet</option>
                            <option value="moonshot-v1-8k">moonshot-v1-8k</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="test-prompt">æµ‹è¯•é—®é¢˜:</label>
                        <textarea id="test-prompt" placeholder="è¯·å°†ä»¥ä¸‹è‡ªç„¶è¯­è¨€é—®é¢˜è½¬æ¢ä¸ºSQLæŸ¥è¯¢ï¼š'æ˜¾ç¤ºå„å¹³å°çš„èµ„äº§åˆ†å¸ƒ'"></textarea>
                    </div>
                    
                    <button class="btn" onclick="testLLMIntegration()">ğŸ§  æµ‹è¯•LLMé›†æˆ</button>
                    <button class="btn btn-secondary" onclick="loadLLMTemplate()">ğŸ“ åŠ è½½æç¤ºæ¨¡æ¿</button>
                    <button class="btn btn-danger" onclick="clearLLMConfig()">ğŸ—‘ï¸ æ¸…ç©ºé…ç½®</button>
                    
                    <div id="llm-status"></div>
                    <div id="llm-results" class="result-box" style="display: none;"></div>
                </div>
            </div>
            
            <!-- ç«¯åˆ°ç«¯æµ‹è¯• -->
            <div id="end-to-end" class="tab-content">
                <div class="test-section">
                    <h2>ğŸ”„ ç«¯åˆ°ç«¯å®Œæ•´æµç¨‹æµ‹è¯•</h2>
                    <p style="margin-bottom: 20px; color: #666;">
                        æ¨¡æ‹Ÿå®Œæ•´çš„ç”¨æˆ·è¯·æ±‚åˆ°å›¾è¡¨é…ç½®ç”Ÿæˆçš„å…¨æµç¨‹
                    </p>
                    
                    <div class="form-group">
                        <label for="e2e-question">ç”¨æˆ·é—®é¢˜:</label>
                        <select id="e2e-question" onchange="loadE2ETemplate()">
                            <option value="">é€‰æ‹©æµ‹è¯•åœºæ™¯...</option>
                            <option value="platform-distribution">å¹³å°èµ„äº§åˆ†å¸ƒåˆ†æ</option>
                            <option value="asset-type-pie">èµ„äº§ç±»å‹å æ¯”é¥¼å›¾</option>
                            <option value="trend-analysis">30å¤©è¶‹åŠ¿åˆ†æ</option>
                            <option value="investment-ranking">æŠ•èµ„æ”¶ç›Šæ’è¡Œ</option>
                            <option value="transaction-table">äº¤æ˜“æ˜ç»†è¡¨æ ¼</option>
                        </select>
                    </div>
                    
                    <div id="e2e-scenario" style="display: none;">
                        <div class="form-group">
                            <label>åœºæ™¯æè¿°:</label>
                            <div id="scenario-description" class="sample-data"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="e2e-user-input">æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥:</label>
                            <input type="text" id="e2e-user-input" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="e2e-expected-chart">é¢„æœŸå›¾è¡¨ç±»å‹:</label>
                            <input type="text" id="e2e-expected-chart" readonly>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="runEndToEndTest()">ğŸš€ è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•</button>
                    <button class="btn btn-secondary" onclick="simulateFlutterIntegration()">ğŸ“± æ¨¡æ‹ŸFlutteré›†æˆ</button>
                    
                    <div id="e2e-status"></div>
                    <div id="e2e-results" class="result-box" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabId) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
        
        // MCPå®¢æˆ·ç«¯æµ‹è¯•ç›¸å…³å‡½æ•°
        function loadQuestionTemplate() {
            const question = document.getElementById('natural-question').value;
            const customGroup = document.getElementById('custom-question-group');
            const sqlTextarea = document.getElementById('mock-sql');
            const dataTextarea = document.getElementById('mock-data');
            
            if (question === 'custom') {
                customGroup.style.display = 'block';
                return;
            } else {
                customGroup.style.display = 'none';
            }
            
            const templates = {
                'æ˜¾ç¤ºå„å¹³å°çš„èµ„äº§åˆ†å¸ƒ': {
                    sql: `SELECT platform, SUM(balance_cny) as total_value, COUNT(*) as asset_count
FROM asset_snapshot 
WHERE snapshot_time = (SELECT MAX(snapshot_time) FROM asset_snapshot)
GROUP BY platform 
ORDER BY total_value DESC`,
                    data: JSON.stringify([
                        {'platform': 'æ”¯ä»˜å®', 'total_value': 158460.30, 'asset_count': 5},
                        {'platform': 'Wise', 'total_value': 8158.23, 'asset_count': 2},
                        {'platform': 'IBKR', 'total_value': 42.03, 'asset_count': 1}
                    ], null, 2)
                },
                'å„èµ„äº§ç±»å‹çš„å æ¯”': {
                    sql: `SELECT asset_type, SUM(balance_cny) as total_value
FROM asset_snapshot
WHERE snapshot_time = (SELECT MAX(snapshot_time) FROM asset_snapshot)
GROUP BY asset_type 
ORDER BY total_value DESC`,
                    data: JSON.stringify([
                        {'asset_type': 'åŸºé‡‘', 'total_value': 150000.0},
                        {'asset_type': 'å¤–æ±‡', 'total_value': 8000.0},
                        {'asset_type': 'è‚¡ç¥¨', 'total_value': 800.0}
                    ], null, 2)
                },
                'æœ€è¿‘30å¤©çš„èµ„äº§å˜åŒ–è¶‹åŠ¿': {
                    sql: `SELECT DATE_TRUNC('day', snapshot_time) as date, SUM(balance_cny) as total_value
FROM asset_snapshot
WHERE snapshot_time >= NOW() - INTERVAL '30 days'
GROUP BY DATE_TRUNC('day', snapshot_time)
ORDER BY date`,
                    data: JSON.stringify([
                        {'date': '2024-01-01', 'total_value': 160000.0},
                        {'date': '2024-01-02', 'total_value': 165000.0},
                        {'date': '2024-01-03', 'total_value': 158000.0},
                        {'date': '2024-01-04', 'total_value': 162000.0}
                    ], null, 2)
                }
            };
            
            if (templates[question]) {
                sqlTextarea.value = templates[question].sql;
                dataTextarea.value = templates[question].data;
            }
        }
        
        function loadSampleData() {
            loadQuestionTemplate();
        }
        
        async function testMCPClient() {
            const statusDiv = document.getElementById('mcp-status');
            const resultsDiv = document.getElementById('mcp-results');
            
            statusDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æµ‹è¯•MCPå®¢æˆ·ç«¯...</div>';
            
            try {
                // æ¨¡æ‹ŸMCPå®¢æˆ·ç«¯æµ‹è¯•
                const question = document.getElementById('natural-question').value || document.getElementById('custom-question').value;
                const sql = document.getElementById('mock-sql').value;
                const dataText = document.getElementById('mock-data').value;
                
                if (!question) {
                    throw new Error('è¯·é€‰æ‹©æˆ–è¾“å…¥ä¸€ä¸ªé—®é¢˜');
                }
                
                // æ¨¡æ‹Ÿå»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                let mockData;
                try {
                    mockData = dataText ? JSON.parse(dataText) : [];
                } catch (e) {
                    throw new Error('æ¨¡æ‹Ÿæ•°æ®JSONæ ¼å¼ä¸æ­£ç¡®');
                }
                
                // ä½¿ç”¨å®é™…çš„å›¾è¡¨é…ç½®ç”Ÿæˆå™¨
                const result = await generateChartConfig(mockData, question, sql);
                
                statusDiv.innerHTML = '<div class="status success">âœ… MCPå®¢æˆ·ç«¯æµ‹è¯•æˆåŠŸï¼</div>';
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = JSON.stringify({
                    success: true,
                    question: question,
                    sql: sql,
                    data_points: mockData.length,
                    chart_config: result,
                    execution_time: '0.5s'
                }, null, 2);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `é”™è¯¯è¯¦æƒ…: ${error.message}`;
            }
        }
        
        function clearMCPResults() {
            document.getElementById('mcp-status').innerHTML = '';
            document.getElementById('mcp-results').style.display = 'none';
            document.getElementById('mock-sql').value = '';
            document.getElementById('mock-data').value = '';
        }
        
        // APIç«¯ç‚¹æµ‹è¯•ç›¸å…³å‡½æ•°
        async function testAPIEndpoint() {
            const statusDiv = document.getElementById('api-status');
            const resultsDiv = document.getElementById('api-results');
            
            statusDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æµ‹è¯•APIç«¯ç‚¹...</div>';
            
            try {
                const baseUrl = document.getElementById('api-base-url').value;
                const question = document.getElementById('api-question').value;
                const currency = document.getElementById('base-currency').value;
                const maxRows = document.getElementById('max-rows').value;
                
                // æ¨¡æ‹ŸAPIè°ƒç”¨
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const mockResponse = {
                    success: true,
                    chart_config: {
                        chart_type: 'bar',
                        title: `${question}åˆ†æ`,
                        description: 'æŸ±çŠ¶å›¾ - é€‚åˆå¯¹æ¯”ä¸åŒç±»åˆ«çš„æ•°å€¼ï¼ŒåŒ…å«3é¡¹æ•°æ®',
                        data: [
                            {name: 'æ”¯ä»˜å®', value: 158460.30},
                            {name: 'Wise', value: 8158.23},
                            {name: 'IBKR', value: 42.03}
                        ],
                        style: {
                            colors: ['#10B981', '#3B82F6', '#F59E0B'],
                            animation: true
                        }
                    },
                    execution_time: 1.2,
                    data_points: 3,
                    method: 'mcp'
                };
                
                statusDiv.innerHTML = '<div class="status success">âœ… APIç«¯ç‚¹æµ‹è¯•æˆåŠŸï¼</div>';
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = JSON.stringify(mockResponse, null, 2);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function checkAPIHealth() {
            const statusDiv = document.getElementById('api-status');
            const resultsDiv = document.getElementById('api-results');
            
            statusDiv.innerHTML = '<div class="status info">ğŸ”„ æ£€æŸ¥APIå¥åº·çŠ¶æ€...</div>';
            
            await new Promise(resolve => setTimeout(resolve, 800));
            
            const healthResponse = {
                status: 'healthy',
                mcp_server_available: true,
                timestamp: new Date().toISOString(),
                message: 'MCPæœåŠ¡å™¨è¿æ¥æ­£å¸¸'
            };
            
            statusDiv.innerHTML = '<div class="status success">âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡ï¼</div>';
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = JSON.stringify(healthResponse, null, 2);
        }
        
        async function getAPIExamples() {
            const statusDiv = document.getElementById('api-status');
            const resultsDiv = document.getElementById('api-results');
            
            statusDiv.innerHTML = '<div class="status info">ğŸ”„ è·å–APIç¤ºä¾‹...</div>';
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const examples = {
                examples: [
                    {
                        question: 'æ˜¾ç¤ºå„å¹³å°çš„èµ„äº§åˆ†å¸ƒ',
                        description: 'æŸ¥çœ‹ä¸åŒå¹³å°çš„èµ„äº§åˆ†é…æƒ…å†µ',
                        expected_chart: 'bar'
                    },
                    {
                        question: 'å„èµ„äº§ç±»å‹çš„å æ¯”',
                        description: 'åˆ†ææŠ•èµ„ç»„åˆä¸­å„ç±»èµ„äº§çš„æ¯”ä¾‹',
                        expected_chart: 'pie'
                    }
                ],
                tips: [
                    'ä½¿ç”¨æè¿°æ€§çš„é—®é¢˜ï¼Œå¦‚\'æ˜¾ç¤º\'ã€\'å¯¹æ¯”\'ã€\'åˆ†æ\'ç­‰',
                    'æŒ‡å®šæ—¶é—´èŒƒå›´ï¼Œå¦‚\'æœ€è¿‘30å¤©\'ã€\'æœ¬æœˆ\'ç­‰'
                ]
            };
            
            statusDiv.innerHTML = '<div class="status success">âœ… ç¤ºä¾‹è·å–æˆåŠŸï¼</div>';
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = JSON.stringify(examples, null, 2);
        }
        
        // LLMé›†æˆæµ‹è¯•ç›¸å…³å‡½æ•°
        function updateLLMConfig() {
            const provider = document.getElementById('llm-provider').value;
            const modelSelect = document.getElementById('llm-model');
            const baseUrlInput = document.getElementById('llm-base-url');
            
            // æ¸…ç©ºå½“å‰é€‰é¡¹
            modelSelect.innerHTML = '';
            
            const modelOptions = {
                openai: [
                    {value: 'gpt-3.5-turbo', text: 'gpt-3.5-turbo'},
                    {value: 'gpt-4', text: 'gpt-4'},
                    {value: 'gpt-4-turbo', text: 'gpt-4-turbo'}
                ],
                anthropic: [
                    {value: 'claude-3-sonnet', text: 'claude-3-sonnet'},
                    {value: 'claude-3-haiku', text: 'claude-3-haiku'}
                ],
                moonshot: [
                    {value: 'moonshot-v1-8k', text: 'moonshot-v1-8k'},
                    {value: 'moonshot-v1-32k', text: 'moonshot-v1-32k'}
                ],
                zhipu: [
                    {value: 'glm-4', text: 'glm-4'},
                    {value: 'glm-3-turbo', text: 'glm-3-turbo'}
                ],
                tongyi: [
                    {value: 'qwen-turbo', text: 'qwen-turbo'},
                    {value: 'qwen-plus', text: 'qwen-plus'}
                ]
            };
            
            const baseUrls = {
                openai: 'https://api.openai.com/v1',
                anthropic: 'https://api.anthropic.com/v1',
                moonshot: 'https://api.moonshot.cn/v1',
                zhipu: 'https://open.bigmodel.cn/api/paas/v4',
                tongyi: 'https://dashscope.aliyuncs.com/api/v1'
            };
            
            modelOptions[provider].forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                modelSelect.appendChild(optionElement);
            });
            
            baseUrlInput.placeholder = baseUrls[provider];
        }
        
        function loadLLMTemplate() {
            const promptTextarea = document.getElementById('test-prompt');
            const template = `è¯·å°†ä»¥ä¸‹è‡ªç„¶è¯­è¨€é—®é¢˜è½¬æ¢ä¸ºé’ˆå¯¹ä¸ªäººè´¢åŠ¡æ•°æ®åº“çš„SQLæŸ¥è¯¢ã€‚

æ•°æ®åº“Schema:
- asset_snapshot: èµ„äº§å¿«ç…§è¡¨ (platform, asset_type, balance_cny, snapshot_time)
- user_operations: ç”¨æˆ·æ“ä½œè¡¨ (operation_date, platform, amount, operation_type)

ç”¨æˆ·é—®é¢˜: "æ˜¾ç¤ºå„å¹³å°çš„èµ„äº§åˆ†å¸ƒ"

è¯·ç”Ÿæˆç›¸åº”çš„SQLæŸ¥è¯¢è¯­å¥ã€‚`;
            
            promptTextarea.value = template;
        }
        
        async function testLLMIntegration() {
            const statusDiv = document.getElementById('llm-status');
            const resultsDiv = document.getElementById('llm-results');
            
            const apiKey = document.getElementById('llm-api-key').value;
            const provider = document.getElementById('llm-provider').value;
            const model = document.getElementById('llm-model').value;
            const prompt = document.getElementById('test-prompt').value;
            
            if (!apiKey) {
                statusDiv.innerHTML = '<div class="status error">âŒ è¯·è¾“å…¥APIå¯†é’¥</div>';
                return;
            }
            
            if (!prompt) {
                statusDiv.innerHTML = '<div class="status error">âŒ è¯·è¾“å…¥æµ‹è¯•æç¤º</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨è°ƒç”¨LLM API...</div>';
            
            try {
                // è¿™é‡Œåº”è¯¥æ˜¯å®é™…çš„LLM APIè°ƒç”¨
                // ç”±äºå®‰å…¨åŸå› ï¼Œæˆ‘ä»¬åªåšæ¨¡æ‹Ÿ
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const mockResponse = {
                    provider: provider,
                    model: model,
                    prompt_tokens: 150,
                    completion_tokens: 85,
                    response: `SELECT platform, SUM(balance_cny) as total_value, COUNT(*) as asset_count
FROM asset_snapshot 
WHERE snapshot_time = (SELECT MAX(snapshot_time) FROM asset_snapshot)
GROUP BY platform 
ORDER BY total_value DESC`,
                    confidence: 0.95,
                    explanation: 'æ ¹æ®ç”¨æˆ·é—®é¢˜ï¼Œç”Ÿæˆäº†æŒ‰å¹³å°åˆ†ç»„çš„èµ„äº§ç»Ÿè®¡æŸ¥è¯¢'
                };
                
                statusDiv.innerHTML = '<div class="status success">âœ… LLMè°ƒç”¨æˆåŠŸï¼</div>';
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = JSON.stringify(mockResponse, null, 2);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ LLMè°ƒç”¨å¤±è´¥: ${error.message}</div>';
            }
        }
        
        function clearLLMConfig() {
            document.getElementById('llm-api-key').value = '';
            document.getElementById('llm-base-url').value = '';
            document.getElementById('test-prompt').value = '';
            document.getElementById('llm-status').innerHTML = '';
            document.getElementById('llm-results').style.display = 'none';
        }
        
        // ç«¯åˆ°ç«¯æµ‹è¯•ç›¸å…³å‡½æ•°
        function loadE2ETemplate() {
            const scenario = document.getElementById('e2e-question').value;
            const scenarioDiv = document.getElementById('e2e-scenario');
            const descDiv = document.getElementById('scenario-description');
            const inputField = document.getElementById('e2e-user-input');
            const chartField = document.getElementById('e2e-expected-chart');
            
            if (!scenario) {
                scenarioDiv.style.display = 'none';
                return;
            }
            
            const scenarios = {
                'platform-distribution': {
                    description: 'ç”¨æˆ·æƒ³è¦æŸ¥çœ‹ä¸åŒå¹³å°ï¼ˆæ”¯ä»˜å®ã€Wiseã€IBKRç­‰ï¼‰çš„èµ„äº§åˆ†å¸ƒæƒ…å†µï¼Œé€‚åˆç”¨æŸ±çŠ¶å›¾å±•ç¤ºå¯¹æ¯”',
                    input: 'æ˜¾ç¤ºå„å¹³å°çš„èµ„äº§åˆ†å¸ƒ',
                    chart: 'bar (æŸ±çŠ¶å›¾)'
                },
                'asset-type-pie': {
                    description: 'ç”¨æˆ·æƒ³è¦åˆ†ææŠ•èµ„ç»„åˆä¸­å„ç±»èµ„äº§ï¼ˆåŸºé‡‘ã€è‚¡ç¥¨ã€å¤–æ±‡ç­‰ï¼‰çš„å æ¯”æƒ…å†µï¼Œé€‚åˆç”¨é¥¼å›¾å±•ç¤º',
                    input: 'å„èµ„äº§ç±»å‹çš„å æ¯”',
                    chart: 'pie (é¥¼å›¾)'
                },
                'trend-analysis': {
                    description: 'ç”¨æˆ·æƒ³è¦æŸ¥çœ‹æœ€è¿‘ä¸€æ®µæ—¶é—´å†…èµ„äº§ä»·å€¼çš„å˜åŒ–è¶‹åŠ¿ï¼Œé€‚åˆç”¨æŠ˜çº¿å›¾å±•ç¤º',
                    input: 'æœ€è¿‘30å¤©çš„èµ„äº§å˜åŒ–è¶‹åŠ¿',
                    chart: 'line (æŠ˜çº¿å›¾)'
                },
                'investment-ranking': {
                    description: 'ç”¨æˆ·æƒ³è¦å¯¹æ¯”ä¸åŒæŠ•èµ„é¡¹ç›®çš„æ”¶ç›Šè¡¨ç°ï¼ŒæŒ‰æ”¶ç›Šé«˜ä½æ’åºå±•ç¤º',
                    input: 'æŠ•èµ„æ”¶ç›Šæ’è¡Œ',
                    chart: 'bar (æŸ±çŠ¶å›¾)'
                },
                'transaction-table': {
                    description: 'ç”¨æˆ·æƒ³è¦æŸ¥çœ‹è¯¦ç»†çš„äº¤æ˜“è®°å½•æ˜ç»†ï¼Œéœ€è¦å±•ç¤ºå¤šä¸ªå­—æ®µçš„è¯¦ç»†ä¿¡æ¯',
                    input: 'è¯¦ç»†çš„äº¤æ˜“è®°å½•',
                    chart: 'table (è¡¨æ ¼)'
                }
            };
            
            const config = scenarios[scenario];
            if (config) {
                scenarioDiv.style.display = 'block';
                descDiv.innerHTML = `<h4>ğŸ“‹ åœºæ™¯è¯´æ˜:</h4><p>${config.description}</p>`;
                inputField.value = config.input;
                chartField.value = config.chart;
            }
        }
        
        async function runEndToEndTest() {
            const statusDiv = document.getElementById('e2e-status');
            const resultsDiv = document.getElementById('e2e-results');
            
            const scenario = document.getElementById('e2e-question').value;
            if (!scenario) {
                statusDiv.innerHTML = '<div class="status error">âŒ è¯·é€‰æ‹©ä¸€ä¸ªæµ‹è¯•åœºæ™¯</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•...</div>';
            
            try {
                const userInput = document.getElementById('e2e-user-input').value;
                const expectedChart = document.getElementById('e2e-expected-chart').value;
                
                // æ¨¡æ‹Ÿå®Œæ•´æµç¨‹
                const steps = [
                    '1. æ¥æ”¶ç”¨æˆ·è¾“å…¥',
                    '2. è‡ªç„¶è¯­è¨€ç†è§£',
                    '3. ç”ŸæˆSQLæŸ¥è¯¢',
                    '4. æ‰§è¡Œæ•°æ®æŸ¥è¯¢',
                    '5. æ•°æ®ç»“æ„åˆ†æ',
                    '6. å›¾è¡¨ç±»å‹åˆ¤æ–­',
                    '7. é…ç½®ç”Ÿæˆ',
                    '8. è¿”å›ç»“æœ'
                ];
                
                let stepResults = [];
                
                for (let i = 0; i < steps.length; i++) {
                    statusDiv.innerHTML = `<div class="status info">ğŸ”„ ${steps[i]}...</div>`;
                    await new Promise(resolve => setTimeout(resolve, 300));
                    stepResults.push(`âœ… ${steps[i]} - æˆåŠŸ`);
                }
                
                const finalResult = {
                    scenario: scenario,
                    user_input: userInput,
                    expected_chart_type: expectedChart,
                    test_steps: stepResults,
                    final_config: {
                        chart_type: expectedChart.split(' ')[0],
                        title: `${userInput}åˆ†æ`,
                        success: true,
                        data_points: 3,
                        execution_time: '2.1s'
                    },
                    flutter_compatibility: {
                        fl_chart_supported: true,
                        config_format: 'JSON',
                        rendering_ready: true
                    }
                };
                
                statusDiv.innerHTML = '<div class="status success">âœ… ç«¯åˆ°ç«¯æµ‹è¯•å®Œæˆï¼</div>';
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = JSON.stringify(finalResult, null, 2);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ ç«¯åˆ°ç«¯æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function simulateFlutterIntegration() {
            const statusDiv = document.getElementById('e2e-status');
            const resultsDiv = document.getElementById('e2e-results');
            
            statusDiv.innerHTML = '<div class="status info">ğŸ”„ æ¨¡æ‹ŸFlutteré›†æˆ...</div>';
            
            const flutterCode = `
// Flutteré›†æˆç¤ºä¾‹ä»£ç 
class MCPChartService {
  static const String baseUrl = 'https://backend-production-2750.up.railway.app';
  
  Future<ChartResult> generateChart(String question) async {
    final response = await http.post(
      Uri.parse('\$baseUrl/api/v1/mcp-smart-chart/generate'),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({
        'question': question,
        'base_currency': 'CNY'
      }),
    );
    
    if (response.statusCode == 200) {
      final data = jsonDecode(response.body);
      return ChartResult.fromJson(data);
    } else {
      throw Exception('å›¾è¡¨ç”Ÿæˆå¤±è´¥');
    }
  }
}

// åœ¨AIå¯¹è¯é¡µé¢ä¸­ä½¿ç”¨
void _handleUserMessage(String message) async {
  if (_isChartRequest(message)) {
    try {
      final chartResult = await _chartService.generateChart(message);
      
      setState(() {
        _messages.add(ChatMessage(
          text: "ğŸ“Š \${chartResult.title}",
          isUser: false,
          chartWidget: _buildChartWidget(chartResult),
        ));
      });
      
      // ä¿å­˜åˆ°æ·±åº¦åˆ†æé¡µé¢
      await _saveToAnalysisPage(chartResult);
      
    } catch (e) {
      _showError(e.toString());
    }
  }
}`;
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            statusDiv.innerHTML = '<div class="status success">âœ… Flutteré›†æˆæ¨¡æ‹Ÿå®Œæˆï¼</div>';
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = flutterCode;
        }
        
        // å›¾è¡¨é…ç½®ç”Ÿæˆå™¨ (å†…åµŒåˆ°HTMLä¸­)
        async function generateChartConfig(queryResult, userQuestion, sql) {
            // ç®€åŒ–ç‰ˆçš„å›¾è¡¨é…ç½®ç”Ÿæˆå™¨
            if (!queryResult || queryResult.length === 0) {
                return {
                    chart_type: 'table',
                    title: 'æ— æ•°æ®',
                    description: `æŸ¥è¯¢"${userQuestion}"æœªè¿”å›æ•°æ®`,
                    data: [{'æç¤º': 'æœªæ‰¾åˆ°åŒ¹é…çš„æ•°æ®'}],
                    style: {'colors': ['#9CA3AF']}
                };
            }
            
            // åˆ†ææ•°æ®ç»“æ„
            const firstRow = queryResult[0];
            const columns = Object.keys(firstRow);
            
            let numericColumns = [];
            let categoricalColumns = [];
            let primaryValueColumn = null;
            let primaryLabelColumn = null;
            
            // åˆ†æåˆ—ç±»å‹
            columns.forEach(col => {
                const value = firstRow[col];
                if (typeof value === 'number') {
                    numericColumns.push(col);
                    if (col.toLowerCase().includes('value') || col.toLowerCase().includes('total') || col.toLowerCase().includes('amount')) {
                        primaryValueColumn = col;
                    }
                } else {
                    categoricalColumns.push(col);
                    if (col.toLowerCase().includes('platform') || col.toLowerCase().includes('type') || col.toLowerCase().includes('name')) {
                        primaryLabelColumn = col;
                    }
                }
            });
            
            // ç¡®å®šå›¾è¡¨ç±»å‹
            let chartType = 'bar'; // é»˜è®¤
            const question = userQuestion.toLowerCase();
            
            if (question.includes('å æ¯”') || question.includes('æ¯”ä¾‹') || question.includes('åˆ†å¸ƒ')) {
                chartType = queryResult.length <= 8 ? 'pie' : 'bar';
            } else if (question.includes('è¶‹åŠ¿') || question.includes('å˜åŒ–') || question.includes('èµ°åŠ¿')) {
                chartType = 'line';
            } else if (question.includes('è¯¦ç»†') || question.includes('æ˜ç»†') || question.includes('è®°å½•')) {
                chartType = 'table';
            }
            
            // æ ¼å¼åŒ–æ•°æ®
            let formattedData = queryResult;
            if (chartType !== 'table' && primaryLabelColumn && primaryValueColumn) {
                formattedData = queryResult.map(row => ({
                    name: row[primaryLabelColumn],
                    value: row[primaryValueColumn],
                    label: row[primaryLabelColumn],
                    ...row
                }));
            }
            
            // ç”Ÿæˆæ ·å¼
            const colors = ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6'];
            const style = {
                colors: colors,
                fontSize: 12,
                fontFamily: 'PingFang SC',
                animation: true,
                animationDuration: 1000
            };
            
            if (chartType === 'pie') {
                style.showPercentage = true;
                style.showLegend = true;
                style.centerText = 'æ€»è®¡';
            } else if (chartType === 'bar') {
                style.barWidth = 20;
                style.showValues = true;
                style.borderRadius = 4;
            } else if (chartType === 'line') {
                style.lineWidth = 3;
                style.showPoints = true;
                style.smooth = true;
            }
            
            return {
                chart_type: chartType,
                title: userQuestion.endsWith('åˆ†æ') ? userQuestion : userQuestion + 'åˆ†æ',
                description: `${chartType === 'pie' ? 'é¥¼å›¾' : chartType === 'line' ? 'æŠ˜çº¿å›¾' : chartType === 'bar' ? 'æŸ±çŠ¶å›¾' : 'è¡¨æ ¼'} - åŒ…å«${queryResult.length}é¡¹æ•°æ®`,
                data: formattedData,
                style: style,
                x_axis: primaryLabelColumn,
                y_axis: primaryValueColumn
            };
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateLLMConfig();
            loadQuestionTemplate();
        });
    </script>
</body>
</html>