<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 MCP智能图表系统 - Mock测试界面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            background: #fafafa;
        }
        
        .test-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        input[type="text"], input[type="url"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="url"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        textarea {
            height: 120px;
            resize: vertical;
        }
        
        .btn {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(90deg, #2196F3, #1976D2);
        }
        
        .btn-danger {
            background: linear-gradient(90deg, #f44336, #d32f2f);
        }
        
        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: #4CAF50;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .sample-data {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .sample-data h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧪 MCP智能图表系统</h1>
            <p>Mock测试界面 - 模拟外部依赖组件</p>
        </div>
        
        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('mcp-client')">MCP客户端测试</button>
                <button class="tab" onclick="showTab('api-test')">API端点测试</button>
                <button class="tab" onclick="showTab('llm-test')">LLM集成测试</button>
                <button class="tab" onclick="showTab('end-to-end')">端到端测试</button>
            </div>
            
            <!-- MCP客户端测试 -->
            <div id="mcp-client" class="tab-content active">
                <div class="test-section">
                    <h2>🔗 MCP数据库客户端模拟</h2>
                    <p style="margin-bottom: 20px; color: #666;">
                        模拟MCP服务器连接和SQL查询，无需实际的PostgreSQL连接
                    </p>
                    
                    <div class="form-group">
                        <label for="mcp-server-url">MCP服务器URL:</label>
                        <input type="url" id="mcp-server-url" value="http://localhost:3001" placeholder="http://localhost:3001">
                    </div>
                    
                    <div class="form-group">
                        <label for="natural-question">自然语言问题:</label>
                        <select id="natural-question" onchange="loadQuestionTemplate()">
                            <option value="">选择一个示例问题...</option>
                            <option value="显示各平台的资产分布">显示各平台的资产分布</option>
                            <option value="各资产类型的占比">各资产类型的占比</option>
                            <option value="最近30天的资产变化趋势">最近30天的资产变化趋势</option>
                            <option value="投资收益排行">投资收益排行</option>
                            <option value="详细的交易记录">详细的交易记录</option>
                            <option value="custom">自定义问题...</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="custom-question-group" style="display: none;">
                        <label for="custom-question">自定义问题:</label>
                        <input type="text" id="custom-question" placeholder="输入您的问题...">
                    </div>
                    
                    <div class="form-group">
                        <label for="mock-sql">模拟生成的SQL (可编辑):</label>
                        <textarea id="mock-sql" placeholder="SELECT平台, SUM(余额) FROM 资产快照 GROUP BY 平台"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="mock-data">模拟查询结果 (JSON格式):</label>
                        <textarea id="mock-data" placeholder="模拟的数据库查询结果"></textarea>
                    </div>
                    
                    <button class="btn" onclick="testMCPClient()">🔍 测试MCP客户端</button>
                    <button class="btn btn-secondary" onclick="loadSampleData()">📊 加载示例数据</button>
                    <button class="btn btn-danger" onclick="clearMCPResults()">🗑️ 清空结果</button>
                    
                    <div id="mcp-status"></div>
                    <div id="mcp-results" class="result-box" style="display: none;"></div>
                </div>
            </div>
            
            <!-- API端点测试 -->
            <div id="api-test" class="tab-content">
                <div class="test-section">
                    <h2>🌐 FastAPI端点模拟</h2>
                    <p style="margin-bottom: 20px; color: #666;">
                        模拟FastAPI图表生成端点，测试完整的请求响应流程
                    </p>
                    
                    <div class="grid">
                        <div>
                            <div class="form-group">
                                <label for="api-base-url">API基础URL:</label>
                                <input type="url" id="api-base-url" value="http://localhost:8000" placeholder="http://localhost:8000">
                            </div>
                            
                            <div class="form-group">
                                <label for="api-question">问题:</label>
                                <input type="text" id="api-question" value="显示各平台的资产分布" placeholder="输入您的问题">
                            </div>
                            
                            <div class="form-group">
                                <label for="base-currency">基准货币:</label>
                                <select id="base-currency">
                                    <option value="CNY">CNY (人民币)</option>
                                    <option value="USD">USD (美元)</option>
                                    <option value="EUR">EUR (欧元)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="max-rows">最大返回行数:</label>
                                <input type="number" id="max-rows" value="1000" min="1" max="10000">
                            </div>
                        </div>
                        
                        <div>
                            <div class="sample-data">
                                <h4>📋 支持的查询示例:</h4>
                                <ul style="padding-left: 20px;">
                                    <li>显示各平台的资产分布</li>
                                    <li>各资产类型的占比</li>
                                    <li>最近30天的资产变化趋势</li>
                                    <li>投资收益排行</li>
                                    <li>详细的交易记录</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="testAPIEndpoint()">🚀 测试API端点</button>
                    <button class="btn btn-secondary" onclick="checkAPIHealth()">❤️ 健康检查</button>
                    <button class="btn btn-secondary" onclick="getAPIExamples()">📝 获取示例</button>
                    
                    <div id="api-status"></div>
                    <div id="api-results" class="result-box" style="display: none;"></div>
                </div>
            </div>
            
            <!-- LLM集成测试 -->
            <div id="llm-test" class="tab-content">
                <div class="test-section">
                    <h2>🤖 LLM API集成测试</h2>
                    <p style="margin-bottom: 20px; color: #666;">
                        <strong>⚠️ 这里可以输入您的LLM API密钥进行测试</strong>
                    </p>
                    
                    <div class="status info">
                        <strong>💡 提示:</strong> 
                        当前系统主要使用预设模板匹配，LLM主要用于处理复杂的自然语言理解。
                        您可以在这里测试LLM增强功能。
                    </div>
                    
                    <div class="form-group">
                        <label for="llm-provider">LLM提供商:</label>
                        <select id="llm-provider" onchange="updateLLMConfig()">
                            <option value="openai">OpenAI GPT</option>
                            <option value="anthropic">Anthropic Claude</option>
                            <option value="moonshot">Moonshot (月之暗面)</option>
                            <option value="zhipu">智谱清言 (GLM)</option>
                            <option value="tongyi">通义千问</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="llm-api-key">API密钥:</label>
                        <input type="password" id="llm-api-key" placeholder="sk-... 或对应的API密钥">
                        <small style="color: #666;">密钥仅用于当前会话测试，不会被保存</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="llm-base-url">API基础URL (可选):</label>
                        <input type="url" id="llm-base-url" placeholder="https://api.openai.com/v1 (留空使用默认)">
                    </div>
                    
                    <div class="form-group">
                        <label for="llm-model">模型:</label>
                        <select id="llm-model">
                            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                            <option value="gpt-4">gpt-4</option>
                            <option value="claude-3-sonnet">claude-3-sonnet</option>
                            <option value="moonshot-v1-8k">moonshot-v1-8k</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="test-prompt">测试问题:</label>
                        <textarea id="test-prompt" placeholder="请将以下自然语言问题转换为SQL查询：'显示各平台的资产分布'"></textarea>
                    </div>
                    
                    <button class="btn" onclick="testLLMIntegration()">🧠 测试LLM集成</button>
                    <button class="btn btn-secondary" onclick="loadLLMTemplate()">📝 加载提示模板</button>
                    <button class="btn btn-danger" onclick="clearLLMConfig()">🗑️ 清空配置</button>
                    
                    <div id="llm-status"></div>
                    <div id="llm-results" class="result-box" style="display: none;"></div>
                </div>
            </div>
            
            <!-- 端到端测试 -->
            <div id="end-to-end" class="tab-content">
                <div class="test-section">
                    <h2>🔄 端到端完整流程测试</h2>
                    <p style="margin-bottom: 20px; color: #666;">
                        模拟完整的用户请求到图表配置生成的全流程
                    </p>
                    
                    <div class="form-group">
                        <label for="e2e-question">用户问题:</label>
                        <select id="e2e-question" onchange="loadE2ETemplate()">
                            <option value="">选择测试场景...</option>
                            <option value="platform-distribution">平台资产分布分析</option>
                            <option value="asset-type-pie">资产类型占比饼图</option>
                            <option value="trend-analysis">30天趋势分析</option>
                            <option value="investment-ranking">投资收益排行</option>
                            <option value="transaction-table">交易明细表格</option>
                        </select>
                    </div>
                    
                    <div id="e2e-scenario" style="display: none;">
                        <div class="form-group">
                            <label>场景描述:</label>
                            <div id="scenario-description" class="sample-data"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="e2e-user-input">模拟用户输入:</label>
                            <input type="text" id="e2e-user-input" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="e2e-expected-chart">预期图表类型:</label>
                            <input type="text" id="e2e-expected-chart" readonly>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="runEndToEndTest()">🚀 运行端到端测试</button>
                    <button class="btn btn-secondary" onclick="simulateFlutterIntegration()">📱 模拟Flutter集成</button>
                    
                    <div id="e2e-status"></div>
                    <div id="e2e-results" class="result-box" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 标签页切换
        function showTab(tabId) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有标签的激活状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
        
        // MCP客户端测试相关函数
        function loadQuestionTemplate() {
            const question = document.getElementById('natural-question').value;
            const customGroup = document.getElementById('custom-question-group');
            const sqlTextarea = document.getElementById('mock-sql');
            const dataTextarea = document.getElementById('mock-data');
            
            if (question === 'custom') {
                customGroup.style.display = 'block';
                return;
            } else {
                customGroup.style.display = 'none';
            }
            
            const templates = {
                '显示各平台的资产分布': {
                    sql: `SELECT platform, SUM(balance_cny) as total_value, COUNT(*) as asset_count
FROM asset_snapshot 
WHERE snapshot_time = (SELECT MAX(snapshot_time) FROM asset_snapshot)
GROUP BY platform 
ORDER BY total_value DESC`,
                    data: JSON.stringify([
                        {'platform': '支付宝', 'total_value': 158460.30, 'asset_count': 5},
                        {'platform': 'Wise', 'total_value': 8158.23, 'asset_count': 2},
                        {'platform': 'IBKR', 'total_value': 42.03, 'asset_count': 1}
                    ], null, 2)
                },
                '各资产类型的占比': {
                    sql: `SELECT asset_type, SUM(balance_cny) as total_value
FROM asset_snapshot
WHERE snapshot_time = (SELECT MAX(snapshot_time) FROM asset_snapshot)
GROUP BY asset_type 
ORDER BY total_value DESC`,
                    data: JSON.stringify([
                        {'asset_type': '基金', 'total_value': 150000.0},
                        {'asset_type': '外汇', 'total_value': 8000.0},
                        {'asset_type': '股票', 'total_value': 800.0}
                    ], null, 2)
                },
                '最近30天的资产变化趋势': {
                    sql: `SELECT DATE_TRUNC('day', snapshot_time) as date, SUM(balance_cny) as total_value
FROM asset_snapshot
WHERE snapshot_time >= NOW() - INTERVAL '30 days'
GROUP BY DATE_TRUNC('day', snapshot_time)
ORDER BY date`,
                    data: JSON.stringify([
                        {'date': '2024-01-01', 'total_value': 160000.0},
                        {'date': '2024-01-02', 'total_value': 165000.0},
                        {'date': '2024-01-03', 'total_value': 158000.0},
                        {'date': '2024-01-04', 'total_value': 162000.0}
                    ], null, 2)
                }
            };
            
            if (templates[question]) {
                sqlTextarea.value = templates[question].sql;
                dataTextarea.value = templates[question].data;
            }
        }
        
        function loadSampleData() {
            loadQuestionTemplate();
        }
        
        async function testMCPClient() {
            const statusDiv = document.getElementById('mcp-status');
            const resultsDiv = document.getElementById('mcp-results');
            
            statusDiv.innerHTML = '<div class="status info">🔄 正在测试MCP客户端...</div>';
            
            try {
                // 模拟MCP客户端测试
                const question = document.getElementById('natural-question').value || document.getElementById('custom-question').value;
                const sql = document.getElementById('mock-sql').value;
                const dataText = document.getElementById('mock-data').value;
                
                if (!question) {
                    throw new Error('请选择或输入一个问题');
                }
                
                // 模拟延迟
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                let mockData;
                try {
                    mockData = dataText ? JSON.parse(dataText) : [];
                } catch (e) {
                    throw new Error('模拟数据JSON格式不正确');
                }
                
                // 使用实际的图表配置生成器
                const result = await generateChartConfig(mockData, question, sql);
                
                statusDiv.innerHTML = '<div class="status success">✅ MCP客户端测试成功！</div>';
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = JSON.stringify({
                    success: true,
                    question: question,
                    sql: sql,
                    data_points: mockData.length,
                    chart_config: result,
                    execution_time: '0.5s'
                }, null, 2);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ 测试失败: ${error.message}</div>`;
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `错误详情: ${error.message}`;
            }
        }
        
        function clearMCPResults() {
            document.getElementById('mcp-status').innerHTML = '';
            document.getElementById('mcp-results').style.display = 'none';
            document.getElementById('mock-sql').value = '';
            document.getElementById('mock-data').value = '';
        }
        
        // API端点测试相关函数
        async function testAPIEndpoint() {
            const statusDiv = document.getElementById('api-status');
            const resultsDiv = document.getElementById('api-results');
            
            statusDiv.innerHTML = '<div class="status info">🔄 正在测试API端点...</div>';
            
            try {
                const baseUrl = document.getElementById('api-base-url').value;
                const question = document.getElementById('api-question').value;
                const currency = document.getElementById('base-currency').value;
                const maxRows = document.getElementById('max-rows').value;
                
                // 模拟API调用
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const mockResponse = {
                    success: true,
                    chart_config: {
                        chart_type: 'bar',
                        title: `${question}分析`,
                        description: '柱状图 - 适合对比不同类别的数值，包含3项数据',
                        data: [
                            {name: '支付宝', value: 158460.30},
                            {name: 'Wise', value: 8158.23},
                            {name: 'IBKR', value: 42.03}
                        ],
                        style: {
                            colors: ['#10B981', '#3B82F6', '#F59E0B'],
                            animation: true
                        }
                    },
                    execution_time: 1.2,
                    data_points: 3,
                    method: 'mcp'
                };
                
                statusDiv.innerHTML = '<div class="status success">✅ API端点测试成功！</div>';
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = JSON.stringify(mockResponse, null, 2);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ API测试失败: ${error.message}</div>`;
            }
        }
        
        async function checkAPIHealth() {
            const statusDiv = document.getElementById('api-status');
            const resultsDiv = document.getElementById('api-results');
            
            statusDiv.innerHTML = '<div class="status info">🔄 检查API健康状态...</div>';
            
            await new Promise(resolve => setTimeout(resolve, 800));
            
            const healthResponse = {
                status: 'healthy',
                mcp_server_available: true,
                timestamp: new Date().toISOString(),
                message: 'MCP服务器连接正常'
            };
            
            statusDiv.innerHTML = '<div class="status success">✅ API健康检查通过！</div>';
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = JSON.stringify(healthResponse, null, 2);
        }
        
        async function getAPIExamples() {
            const statusDiv = document.getElementById('api-status');
            const resultsDiv = document.getElementById('api-results');
            
            statusDiv.innerHTML = '<div class="status info">🔄 获取API示例...</div>';
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const examples = {
                examples: [
                    {
                        question: '显示各平台的资产分布',
                        description: '查看不同平台的资产分配情况',
                        expected_chart: 'bar'
                    },
                    {
                        question: '各资产类型的占比',
                        description: '分析投资组合中各类资产的比例',
                        expected_chart: 'pie'
                    }
                ],
                tips: [
                    '使用描述性的问题，如\'显示\'、\'对比\'、\'分析\'等',
                    '指定时间范围，如\'最近30天\'、\'本月\'等'
                ]
            };
            
            statusDiv.innerHTML = '<div class="status success">✅ 示例获取成功！</div>';
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = JSON.stringify(examples, null, 2);
        }
        
        // LLM集成测试相关函数
        function updateLLMConfig() {
            const provider = document.getElementById('llm-provider').value;
            const modelSelect = document.getElementById('llm-model');
            const baseUrlInput = document.getElementById('llm-base-url');
            
            // 清空当前选项
            modelSelect.innerHTML = '';
            
            const modelOptions = {
                openai: [
                    {value: 'gpt-3.5-turbo', text: 'gpt-3.5-turbo'},
                    {value: 'gpt-4', text: 'gpt-4'},
                    {value: 'gpt-4-turbo', text: 'gpt-4-turbo'}
                ],
                anthropic: [
                    {value: 'claude-3-sonnet', text: 'claude-3-sonnet'},
                    {value: 'claude-3-haiku', text: 'claude-3-haiku'}
                ],
                moonshot: [
                    {value: 'moonshot-v1-8k', text: 'moonshot-v1-8k'},
                    {value: 'moonshot-v1-32k', text: 'moonshot-v1-32k'}
                ],
                zhipu: [
                    {value: 'glm-4', text: 'glm-4'},
                    {value: 'glm-3-turbo', text: 'glm-3-turbo'}
                ],
                tongyi: [
                    {value: 'qwen-turbo', text: 'qwen-turbo'},
                    {value: 'qwen-plus', text: 'qwen-plus'}
                ]
            };
            
            const baseUrls = {
                openai: 'https://api.openai.com/v1',
                anthropic: 'https://api.anthropic.com/v1',
                moonshot: 'https://api.moonshot.cn/v1',
                zhipu: 'https://open.bigmodel.cn/api/paas/v4',
                tongyi: 'https://dashscope.aliyuncs.com/api/v1'
            };
            
            modelOptions[provider].forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                modelSelect.appendChild(optionElement);
            });
            
            baseUrlInput.placeholder = baseUrls[provider];
        }
        
        function loadLLMTemplate() {
            const promptTextarea = document.getElementById('test-prompt');
            const template = `请将以下自然语言问题转换为针对个人财务数据库的SQL查询。

数据库Schema:
- asset_snapshot: 资产快照表 (platform, asset_type, balance_cny, snapshot_time)
- user_operations: 用户操作表 (operation_date, platform, amount, operation_type)

用户问题: "显示各平台的资产分布"

请生成相应的SQL查询语句。`;
            
            promptTextarea.value = template;
        }
        
        async function testLLMIntegration() {
            const statusDiv = document.getElementById('llm-status');
            const resultsDiv = document.getElementById('llm-results');
            
            const apiKey = document.getElementById('llm-api-key').value;
            const provider = document.getElementById('llm-provider').value;
            const model = document.getElementById('llm-model').value;
            const prompt = document.getElementById('test-prompt').value;
            
            if (!apiKey) {
                statusDiv.innerHTML = '<div class="status error">❌ 请输入API密钥</div>';
                return;
            }
            
            if (!prompt) {
                statusDiv.innerHTML = '<div class="status error">❌ 请输入测试提示</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="status info">🔄 正在调用LLM API...</div>';
            
            try {
                // 这里应该是实际的LLM API调用
                // 由于安全原因，我们只做模拟
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const mockResponse = {
                    provider: provider,
                    model: model,
                    prompt_tokens: 150,
                    completion_tokens: 85,
                    response: `SELECT platform, SUM(balance_cny) as total_value, COUNT(*) as asset_count
FROM asset_snapshot 
WHERE snapshot_time = (SELECT MAX(snapshot_time) FROM asset_snapshot)
GROUP BY platform 
ORDER BY total_value DESC`,
                    confidence: 0.95,
                    explanation: '根据用户问题，生成了按平台分组的资产统计查询'
                };
                
                statusDiv.innerHTML = '<div class="status success">✅ LLM调用成功！</div>';
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = JSON.stringify(mockResponse, null, 2);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ LLM调用失败: ${error.message}</div>';
            }
        }
        
        function clearLLMConfig() {
            document.getElementById('llm-api-key').value = '';
            document.getElementById('llm-base-url').value = '';
            document.getElementById('test-prompt').value = '';
            document.getElementById('llm-status').innerHTML = '';
            document.getElementById('llm-results').style.display = 'none';
        }
        
        // 端到端测试相关函数
        function loadE2ETemplate() {
            const scenario = document.getElementById('e2e-question').value;
            const scenarioDiv = document.getElementById('e2e-scenario');
            const descDiv = document.getElementById('scenario-description');
            const inputField = document.getElementById('e2e-user-input');
            const chartField = document.getElementById('e2e-expected-chart');
            
            if (!scenario) {
                scenarioDiv.style.display = 'none';
                return;
            }
            
            const scenarios = {
                'platform-distribution': {
                    description: '用户想要查看不同平台（支付宝、Wise、IBKR等）的资产分布情况，适合用柱状图展示对比',
                    input: '显示各平台的资产分布',
                    chart: 'bar (柱状图)'
                },
                'asset-type-pie': {
                    description: '用户想要分析投资组合中各类资产（基金、股票、外汇等）的占比情况，适合用饼图展示',
                    input: '各资产类型的占比',
                    chart: 'pie (饼图)'
                },
                'trend-analysis': {
                    description: '用户想要查看最近一段时间内资产价值的变化趋势，适合用折线图展示',
                    input: '最近30天的资产变化趋势',
                    chart: 'line (折线图)'
                },
                'investment-ranking': {
                    description: '用户想要对比不同投资项目的收益表现，按收益高低排序展示',
                    input: '投资收益排行',
                    chart: 'bar (柱状图)'
                },
                'transaction-table': {
                    description: '用户想要查看详细的交易记录明细，需要展示多个字段的详细信息',
                    input: '详细的交易记录',
                    chart: 'table (表格)'
                }
            };
            
            const config = scenarios[scenario];
            if (config) {
                scenarioDiv.style.display = 'block';
                descDiv.innerHTML = `<h4>📋 场景说明:</h4><p>${config.description}</p>`;
                inputField.value = config.input;
                chartField.value = config.chart;
            }
        }
        
        async function runEndToEndTest() {
            const statusDiv = document.getElementById('e2e-status');
            const resultsDiv = document.getElementById('e2e-results');
            
            const scenario = document.getElementById('e2e-question').value;
            if (!scenario) {
                statusDiv.innerHTML = '<div class="status error">❌ 请选择一个测试场景</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="status info">🔄 正在运行端到端测试...</div>';
            
            try {
                const userInput = document.getElementById('e2e-user-input').value;
                const expectedChart = document.getElementById('e2e-expected-chart').value;
                
                // 模拟完整流程
                const steps = [
                    '1. 接收用户输入',
                    '2. 自然语言理解',
                    '3. 生成SQL查询',
                    '4. 执行数据查询',
                    '5. 数据结构分析',
                    '6. 图表类型判断',
                    '7. 配置生成',
                    '8. 返回结果'
                ];
                
                let stepResults = [];
                
                for (let i = 0; i < steps.length; i++) {
                    statusDiv.innerHTML = `<div class="status info">🔄 ${steps[i]}...</div>`;
                    await new Promise(resolve => setTimeout(resolve, 300));
                    stepResults.push(`✅ ${steps[i]} - 成功`);
                }
                
                const finalResult = {
                    scenario: scenario,
                    user_input: userInput,
                    expected_chart_type: expectedChart,
                    test_steps: stepResults,
                    final_config: {
                        chart_type: expectedChart.split(' ')[0],
                        title: `${userInput}分析`,
                        success: true,
                        data_points: 3,
                        execution_time: '2.1s'
                    },
                    flutter_compatibility: {
                        fl_chart_supported: true,
                        config_format: 'JSON',
                        rendering_ready: true
                    }
                };
                
                statusDiv.innerHTML = '<div class="status success">✅ 端到端测试完成！</div>';
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = JSON.stringify(finalResult, null, 2);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ 端到端测试失败: ${error.message}</div>`;
            }
        }
        
        async function simulateFlutterIntegration() {
            const statusDiv = document.getElementById('e2e-status');
            const resultsDiv = document.getElementById('e2e-results');
            
            statusDiv.innerHTML = '<div class="status info">🔄 模拟Flutter集成...</div>';
            
            const flutterCode = `
// Flutter集成示例代码
class MCPChartService {
  static const String baseUrl = 'https://backend-production-2750.up.railway.app';
  
  Future<ChartResult> generateChart(String question) async {
    final response = await http.post(
      Uri.parse('\$baseUrl/api/v1/mcp-smart-chart/generate'),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({
        'question': question,
        'base_currency': 'CNY'
      }),
    );
    
    if (response.statusCode == 200) {
      final data = jsonDecode(response.body);
      return ChartResult.fromJson(data);
    } else {
      throw Exception('图表生成失败');
    }
  }
}

// 在AI对话页面中使用
void _handleUserMessage(String message) async {
  if (_isChartRequest(message)) {
    try {
      final chartResult = await _chartService.generateChart(message);
      
      setState(() {
        _messages.add(ChatMessage(
          text: "📊 \${chartResult.title}",
          isUser: false,
          chartWidget: _buildChartWidget(chartResult),
        ));
      });
      
      // 保存到深度分析页面
      await _saveToAnalysisPage(chartResult);
      
    } catch (e) {
      _showError(e.toString());
    }
  }
}`;
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            statusDiv.innerHTML = '<div class="status success">✅ Flutter集成模拟完成！</div>';
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = flutterCode;
        }
        
        // 图表配置生成器 (内嵌到HTML中)
        async function generateChartConfig(queryResult, userQuestion, sql) {
            // 简化版的图表配置生成器
            if (!queryResult || queryResult.length === 0) {
                return {
                    chart_type: 'table',
                    title: '无数据',
                    description: `查询"${userQuestion}"未返回数据`,
                    data: [{'提示': '未找到匹配的数据'}],
                    style: {'colors': ['#9CA3AF']}
                };
            }
            
            // 分析数据结构
            const firstRow = queryResult[0];
            const columns = Object.keys(firstRow);
            
            let numericColumns = [];
            let categoricalColumns = [];
            let primaryValueColumn = null;
            let primaryLabelColumn = null;
            
            // 分析列类型
            columns.forEach(col => {
                const value = firstRow[col];
                if (typeof value === 'number') {
                    numericColumns.push(col);
                    if (col.toLowerCase().includes('value') || col.toLowerCase().includes('total') || col.toLowerCase().includes('amount')) {
                        primaryValueColumn = col;
                    }
                } else {
                    categoricalColumns.push(col);
                    if (col.toLowerCase().includes('platform') || col.toLowerCase().includes('type') || col.toLowerCase().includes('name')) {
                        primaryLabelColumn = col;
                    }
                }
            });
            
            // 确定图表类型
            let chartType = 'bar'; // 默认
            const question = userQuestion.toLowerCase();
            
            if (question.includes('占比') || question.includes('比例') || question.includes('分布')) {
                chartType = queryResult.length <= 8 ? 'pie' : 'bar';
            } else if (question.includes('趋势') || question.includes('变化') || question.includes('走势')) {
                chartType = 'line';
            } else if (question.includes('详细') || question.includes('明细') || question.includes('记录')) {
                chartType = 'table';
            }
            
            // 格式化数据
            let formattedData = queryResult;
            if (chartType !== 'table' && primaryLabelColumn && primaryValueColumn) {
                formattedData = queryResult.map(row => ({
                    name: row[primaryLabelColumn],
                    value: row[primaryValueColumn],
                    label: row[primaryLabelColumn],
                    ...row
                }));
            }
            
            // 生成样式
            const colors = ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6'];
            const style = {
                colors: colors,
                fontSize: 12,
                fontFamily: 'PingFang SC',
                animation: true,
                animationDuration: 1000
            };
            
            if (chartType === 'pie') {
                style.showPercentage = true;
                style.showLegend = true;
                style.centerText = '总计';
            } else if (chartType === 'bar') {
                style.barWidth = 20;
                style.showValues = true;
                style.borderRadius = 4;
            } else if (chartType === 'line') {
                style.lineWidth = 3;
                style.showPoints = true;
                style.smooth = true;
            }
            
            return {
                chart_type: chartType,
                title: userQuestion.endsWith('分析') ? userQuestion : userQuestion + '分析',
                description: `${chartType === 'pie' ? '饼图' : chartType === 'line' ? '折线图' : chartType === 'bar' ? '柱状图' : '表格'} - 包含${queryResult.length}项数据`,
                data: formattedData,
                style: style,
                x_axis: primaryLabelColumn,
                y_axis: primaryValueColumn
            };
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateLLMConfig();
            loadQuestionTemplate();
        });
    </script>
</body>
</html>