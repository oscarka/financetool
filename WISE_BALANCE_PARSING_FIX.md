# Wise API ä½™é¢è§£ææ•°å€¼è½¬æ¢é—®é¢˜ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

åœ¨è§£æWise APIå›ä¼ çš„ä½™é¢æ•°æ®æ—¶ï¼Œå‘ç°å­˜åœ¨æ•°å€¼è½¬æ¢é—®é¢˜ã€‚å½“APIè¿”å›çš„ä½™é¢å€¼ä¸æ˜¯æœ‰æ•ˆçš„æ•°å­—æ ¼å¼æ—¶ï¼Œä¼šå¯¼è‡´`ValueError`å¼‚å¸¸ï¼Œå½±å“ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### 1. åŸå§‹ä»£ç é—®é¢˜
åœ¨ `backend/app/services/wise_api_service.py` çš„ç¬¬199-202è¡Œï¼š

```python
"available_balance": float(balance.get('amount', {}).get('value', 0)),
"reserved_balance": float(balance.get('reservedAmount', {}).get('value', 0)),
"cash_amount": float(balance.get('cashAmount', {}).get('value', 0)),
"total_worth": float(balance.get('totalWorth', {}).get('value', 0)),
```

### 2. æ½œåœ¨é—®é¢˜åœºæ™¯
- APIè¿”å›çš„`value`å­—æ®µä¸º`None`
- APIè¿”å›çš„`value`å­—æ®µä¸ºç©ºå­—ç¬¦ä¸²`""`
- APIè¿”å›çš„`value`å­—æ®µä¸ºæ— æ•ˆå­—ç¬¦ä¸²ï¼ˆå¦‚`"invalid"`ã€`"123.456.789"`ï¼‰
- åµŒå¥—å­—å…¸ç»“æ„å¼‚å¸¸ï¼ˆå¦‚`amount`å­—æ®µä¸æ˜¯å­—å…¸è€Œæ˜¯å­—ç¬¦ä¸²ï¼‰

### 3. å½±å“èŒƒå›´
- å½“é‡åˆ°å¼‚å¸¸æ•°æ®æ—¶ï¼Œæ•´ä¸ªä½™é¢è·å–æµç¨‹ä¼šå¤±è´¥
- ç”¨æˆ·æ— æ³•çœ‹åˆ°ä»»ä½•è´¦æˆ·ä½™é¢ä¿¡æ¯
- ç³»ç»Ÿæ—¥å¿—ä¸­ä¼šå‡ºç°`ValueError`å¼‚å¸¸

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ å®‰å…¨æ•°å€¼è½¬æ¢æ–¹æ³•
åœ¨`WiseAPIService`ç±»ä¸­æ·»åŠ äº†`_safe_float`æ–¹æ³•ï¼š

```python
def _safe_float(self, value, default=0.0):
    """å®‰å…¨åœ°å°†å€¼è½¬æ¢ä¸ºæµ®ç‚¹æ•°"""
    if value is None or value == "":
        return default
    try:
        return float(value)
    except (ValueError, TypeError):
        logger.warning(f"[Wise] æ— æ³•è½¬æ¢ä½™é¢å€¼: {value}, ä½¿ç”¨é»˜è®¤å€¼: {default}")
        return default
```

### 2. æ”¹è¿›ä½™é¢è§£æé€»è¾‘
ä¿®æ”¹äº†`get_all_account_balances`æ–¹æ³•ä¸­çš„ä½™é¢è§£æéƒ¨åˆ†ï¼š

```python
# å®‰å…¨è·å–åµŒå¥—å­—å…¸å€¼
amount_data = balance.get('amount', {})
reserved_data = balance.get('reservedAmount', {})
cash_data = balance.get('cashAmount', {})
total_data = balance.get('totalWorth', {})

all_balances.append({
    "account_id": balance_id,
    "currency": balance.get('currency'),
    "available_balance": self._safe_float(amount_data.get('value', 0) if isinstance(amount_data, dict) else 0),
    "reserved_balance": self._safe_float(reserved_data.get('value', 0) if isinstance(reserved_data, dict) else 0),
    "cash_amount": self._safe_float(cash_data.get('value', 0) if isinstance(cash_data, dict) else 0),
    "total_worth": self._safe_float(total_data.get('value', 0) if isinstance(total_data, dict) else 0),
    # ... å…¶ä»–å­—æ®µ
})
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹è¦†ç›–
1. **æ­£å¸¸æ•°æ®** - æ ‡å‡†çš„æ•°å­—å­—ç¬¦ä¸²æ ¼å¼
2. **ç©ºå€¼æ•°æ®** - Noneå’Œç©ºå­—ç¬¦ä¸²
3. **æ— æ•ˆå­—ç¬¦ä¸²æ•°æ®** - éæ•°å­—å­—ç¬¦ä¸²
4. **ç¼ºå¤±å­—æ®µæ•°æ®** - ç¼ºå°‘ä½™é¢ç›¸å…³å­—æ®µ
5. **éå­—å…¸å­—æ®µæ•°æ®** - åµŒå¥—ç»“æ„å¼‚å¸¸

### æµ‹è¯•ç»“æœ
```
=== æµ‹è¯•ç»“æœ ===
æˆåŠŸ: 5/5
æˆåŠŸç‡: 100.0%
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ä¿®å¤æˆåŠŸï¼
```

## ğŸ“‹ ä¿®å¤æ•ˆæœ

### 1. é”™è¯¯å¤„ç†
- âœ… å¤„ç†`None`å€¼
- âœ… å¤„ç†ç©ºå­—ç¬¦ä¸²
- âœ… å¤„ç†æ— æ•ˆæ•°å­—å­—ç¬¦ä¸²
- âœ… å¤„ç†åµŒå¥—ç»“æ„å¼‚å¸¸

### 2. æ—¥å¿—è®°å½•
- âœ… è®°å½•è½¬æ¢å¤±è´¥çš„è­¦å‘Šæ—¥å¿—
- âœ… ä¾¿äºé—®é¢˜è¿½è¸ªå’Œè°ƒè¯•

### 3. ç³»ç»Ÿç¨³å®šæ€§
- âœ… é¿å…å› å¼‚å¸¸æ•°æ®å¯¼è‡´æ•´ä¸ªæµç¨‹å¤±è´¥
- âœ… ä¿è¯ç”¨æˆ·å§‹ç»ˆèƒ½çœ‹åˆ°è´¦æˆ·ä¿¡æ¯ï¼ˆå³ä½¿éƒ¨åˆ†æ•°æ®å¼‚å¸¸ï¼‰

## ğŸ”§ å®æ–½æ­¥éª¤

1. **ä»£ç ä¿®æ”¹** âœ…
   - åœ¨`WiseAPIService`ç±»ä¸­æ·»åŠ `_safe_float`æ–¹æ³•
   - ä¿®æ”¹`get_all_account_balances`æ–¹æ³•ä¸­çš„ä½™é¢è§£æé€»è¾‘

2. **æµ‹è¯•éªŒè¯** âœ…
   - åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯ä¿®å¤æ•ˆæœ
   - è¦†ç›–å„ç§å¼‚å¸¸æƒ…å†µ

3. **éƒ¨ç½²éªŒè¯** â³
   - åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éªŒè¯ä¿®å¤æ•ˆæœ
   - ç›‘æ§æ—¥å¿—ç¡®è®¤å¼‚å¸¸å¤„ç†æ­£å¸¸

## ğŸ“Š ç›‘æ§å»ºè®®

### 1. æ—¥å¿—ç›‘æ§
å…³æ³¨ä»¥ä¸‹æ—¥å¿—æ¨¡å¼ï¼š
```
[Wise] æ— æ³•è½¬æ¢ä½™é¢å€¼: {value}, ä½¿ç”¨é»˜è®¤å€¼: {default}
```

### 2. æ•°æ®è´¨é‡ç›‘æ§
- ç»Ÿè®¡å¼‚å¸¸æ•°æ®çš„é¢‘ç‡
- åˆ†æå¼‚å¸¸æ•°æ®çš„æ¨¡å¼
- ä¸Wise APIå›¢é˜Ÿæ²Ÿé€šæ•°æ®æ ¼å¼é—®é¢˜

### 3. ç”¨æˆ·åé¦ˆ
- ç›‘æ§ç”¨æˆ·å…³äºä½™é¢æ˜¾ç¤ºé—®é¢˜çš„åé¦ˆ
- ç¡®è®¤ä¿®å¤åç”¨æˆ·ä½“éªŒçš„æ”¹å–„

## ğŸ¯ æ€»ç»“

é€šè¿‡æ·»åŠ å®‰å…¨çš„æ•°å€¼è½¬æ¢é€»è¾‘ï¼ŒæˆåŠŸè§£å†³äº†Wise APIä½™é¢è§£æä¸­çš„æ•°å€¼è½¬æ¢é—®é¢˜ã€‚ä¿®å¤åçš„ä»£ç èƒ½å¤Ÿï¼š

1. **ä¼˜é›…å¤„ç†å¼‚å¸¸æ•°æ®** - ä¸ä¼šå› ä¸ºå¼‚å¸¸æ•°æ®å¯¼è‡´ç³»ç»Ÿå´©æºƒ
2. **ä¿æŒæ•°æ®å®Œæ•´æ€§** - å¼‚å¸¸æ•°æ®ä½¿ç”¨é»˜è®¤å€¼ï¼Œä¿è¯æ•°æ®ç»“æ„å®Œæ•´
3. **æä¾›è°ƒè¯•ä¿¡æ¯** - é€šè¿‡æ—¥å¿—è®°å½•å¼‚å¸¸æƒ…å†µï¼Œä¾¿äºé—®é¢˜è¿½è¸ª
4. **æå‡ç”¨æˆ·ä½“éªŒ** - ç”¨æˆ·å§‹ç»ˆèƒ½çœ‹åˆ°è´¦æˆ·ä¿¡æ¯ï¼Œå³ä½¿éƒ¨åˆ†æ•°æ®å¼‚å¸¸

è¿™ä¸ªä¿®å¤ç¡®ä¿äº†Wise APIé›†æˆçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚