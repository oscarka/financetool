# Flutter Web åº”ç”¨ - Railway éƒ¨ç½²ä¸“ç”¨
FROM debian:latest AS flutter-build

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    git \
    unzip \
    xz-utils \
    zip \
    libglu1-mesa \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºflutterç”¨æˆ·
RUN useradd -m -s /bin/bash flutter

# åˆ‡æ¢åˆ°flutterç”¨æˆ·
USER flutter

# è®¾ç½®Flutterç¯å¢ƒå˜é‡
ENV FLUTTER_HOME="/home/flutter/flutter"
ENV PATH="$FLUTTER_HOME/bin:$PATH"

# ä¸‹è½½å¹¶å®‰è£…Flutter SDK
RUN git clone --depth 1 -b stable https://github.com/flutter/flutter.git $FLUTTER_HOME

# åˆå§‹åŒ–Flutter
RUN flutter doctor

# åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶Flutteré…ç½®æ–‡ä»¶ (é‡å‘½åä»¥é¿å…Railwayè‡ªåŠ¨æ£€æµ‹)
COPY --chown=flutter:flutter personal_finance_flutter/flutter_pubspec.yaml pubspec.yaml
COPY --chown=flutter:flutter personal_finance_flutter/pubspec.lock ./

# å®‰è£…Flutterä¾èµ– - æ˜ç¡®ä½¿ç”¨flutter pub get
RUN flutter pub get

# å¤åˆ¶æ‰€æœ‰æºä»£ç 
COPY --chown=flutter:flutter personal_finance_flutter/ .

# æ„å»ºFlutter Webåº”ç”¨
RUN flutter build web --release --no-tree-shake-icons

# ç”Ÿäº§ç¯å¢ƒ - ä½¿ç”¨nginxæä¾›é™æ€æ–‡ä»¶æœåŠ¡
FROM nginx:alpine AS production

# å®‰è£…gettextç”¨äºç¯å¢ƒå˜é‡æ›¿æ¢ï¼Œnet-toolsç”¨äºè°ƒè¯•
RUN apk add --no-cache gettext net-tools

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶webæ–‡ä»¶
COPY --from=flutter-build /app/build/web /usr/share/nginx/html

# å†…è”åˆ›å»ºnginxé…ç½®æ¨¡æ¿ï¼ˆä½¿ç”¨printfé¿å…Dockerfileè¯­æ³•å†²çªï¼‰
RUN printf 'server {\n    listen $PORT;\n    server_name localhost;\n\n    location / {\n        root /usr/share/nginx/html;\n        index index.html;\n        try_files $uri $uri/ /index.html;\n    }\n\n    location /health {\n        return 200 "healthy\\n";\n        add_header Content-Type text/plain;\n    }\n\n    location /debug {\n        return 200 "Container running on port $PORT\\n";\n        add_header Content-Type text/plain;\n    }\n}\n' > /etc/nginx/conf.d/default.conf.template

# åˆ›å»ºå¤‡ç”¨index.htmlï¼ˆä½¿ç”¨printfé¿å…heredocé—®é¢˜ï¼‰
RUN printf '<!DOCTYPE html>\n<html>\n<head><title>Flutter App - Container Running</title></head>\n<body style="font-family: Arial; text-align: center; padding: 50px;">\n<h1>ğŸ‰ Flutter App Container is Running!</h1>\n<p>âœ… Docker build successful</p>\n<p>âœ… Nginx configured</p>\n<p>âœ… Container started</p>\n<p><a href="/health">Health Check</a> | <a href="/debug">Debug Info</a></p>\n</body>\n</html>\n' > /backup-index.html

# éªŒè¯åˆ›å»ºçš„æ–‡ä»¶
RUN echo "=== Created files ===" && \
    ls -la /etc/nginx/conf.d/default.conf.template && \
    ls -la /backup-index.html && \
    echo "=== Template content ===" && \
    cat /etc/nginx/conf.d/default.conf.template

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PORT=80

# æš´éœ²ç«¯å£
EXPOSE $PORT

# å®Œå…¨è‡ªåŒ…å«çš„å¯åŠ¨å‘½ä»¤
CMD ["/bin/bash", "-c", "\
    export PORT=${PORT:-80} && \
    echo '=== Container Starting on port:' $PORT '===' && \
    if [ ! -f '/usr/share/nginx/html/index.html' ] || [ ! -s '/usr/share/nginx/html/index.html' ]; then \
    echo 'Flutter index.html missing, using backup' && \
    cp /backup-index.html /usr/share/nginx/html/index.html; \
    fi && \
    echo 'Processing nginx template...' && \
    envsubst '$PORT' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && \
    echo 'Generated nginx config:' && \
    cat /etc/nginx/conf.d/default.conf && \
    echo 'Testing nginx config...' && \
    nginx -t && \
    echo 'Starting nginx...' && \
    exec nginx -g 'daemon off;'\
    "]
