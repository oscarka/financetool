name: ðŸš€ FinanceTool Auto Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'éƒ¨ç½²ç›®æ ‡'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - backend
        - worker
        - frontend

jobs:
  deploy-backend:
    if: github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'backend' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Install Railway CLI
        run: npm install -g @railway/cli
        
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd backend
          railway up --detach
          
  deploy-worker:
    if: github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'worker' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Install Wrangler
        run: npm install -g wrangler
        
      - name: Deploy Cloudflare Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd cloudflare-workers
          wrangler deploy
          
  deploy-frontend:
    if: github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'frontend' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          cd frontend
          npm install
          
      - name: Build frontend
        run: |
          cd frontend
          npm run build
          
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          cd frontend
          npx vercel --prod --token $VERCEL_TOKEN
          
  test-deployment:
    if: github.event.inputs.deploy_target == 'all' || github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-worker, deploy-frontend]
    steps:
      - name: Test Cloudflare Worker
        run: |
          curl -f https://financetool-proxy.oscarzhangunsw.workers.dev/health || exit 1
          
      - name: Test Railway Backend
        run: |
          curl -f https://backend-production-2750.up.railway.app/ || exit 1
          
      - name: Test Vercel Frontend
        run: |
          curl -f https://financetool-qi8cex1ev-oscarkas-projects.vercel.app/ || exit 1
