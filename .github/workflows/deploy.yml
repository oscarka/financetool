name: Smart Deploy to Railway

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      backend-changed: ${{ steps.changes.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changes
        id: changes
        run: |
          # æ£€æŸ¥frontendç›®å½•å˜åŒ–
          if git diff --name-only HEAD~1 | grep -q "^frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi
          
          # æ£€æŸ¥backendç›®å½•å˜åŒ–
          if git diff --name-only HEAD~1 | grep -q "^backend/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi


  
   deploy-frontend:
     needs: detect-changes
     if: needs.detect-changes.outputs.frontend-changed == 'true'
     runs-on: ubuntu-latest
     container: ghcr.io/railwayapp/cli:latest
     steps:
       - uses: actions/checkout@v4
       
       - name: Deploy Frontend to Railway
         run: |
           cd frontend
           railway up
         env:
           RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

   deploy-backend:
     needs: detect-changes
     if: needs.detect-changes.outputs.backend-changed == 'true'
     runs-on: ubuntu-latest
     container: ghcr.io/railwayapp/cli:latest
     steps:
       - uses: actions/checkout@v4
       
       - name: Deploy Backend to Railway
         run: |
           cd backend
           railway up
         env:
           RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  
  # æ·»åŠ ä¸€ä¸ªæç¤ºä»»åŠ¡
  deployment-notice:
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Notice
        run: |
          echo "ğŸš§ Railwayéƒ¨ç½²å½“å‰å·²æš‚åœ"
          echo "ğŸ“‹ éœ€è¦é…ç½®RAILWAY_TOKENåå¯ç”¨è‡ªåŠ¨éƒ¨ç½²"
          echo "ğŸ“– è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹: RAILWAY_DEPLOYMENT_FIX.md"
          if [ "${{ needs.detect-changes.outputs.frontend-changed }}" == "true" ]; then
            echo "âœ… æ£€æµ‹åˆ°å‰ç«¯ä»£ç å˜æ›´"
          fi
          if [ "${{ needs.detect-changes.outputs.backend-changed }}" == "true" ]; then
            echo "âœ… æ£€æµ‹åˆ°åç«¯ä»£ç å˜æ›´"
          fi 
